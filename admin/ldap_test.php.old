<?php 
/**								  		ldap_test.php
 * This is a two steps process for inserting:
 * 1) Teachers
 * 2) Students
 * into the LDAP directory
 */

$choice='ldap_test.php';
$action='ldap_test_action.php';

require_once('../school.php');
require_once('../classdev/logbook/permissions.php');
require_once('../classdev/lib/fetch_student.php');

/* Connect to LDAP server */
$ds = ldap_connect("localhost");

/* Make sure of right LDAP version is being used */
ldap_set_option($ds, LDAP_OPT_PROTOCOL_VERSION, 3);

if ($ds) {
	/* Bind to LDAP DB */
	$userrdn="cn=" . $CFG->ldapuser . ",dc=example,dc=com";
  $bind_result = ldap_bind($ds, $userrdn, $CFG->ldappasswd);
	
	$info = array();
	
	if ($bind_result) {

	
/**
 *	STEP 1: Process all users (teachers) from ClaSS
 *	
 */
		$users = list_all_users('0');

		/* process result */
		foreach($users as $uid => $row) {

	    /* Search for entry in LDAP */
			$username=$row['username'];
	    $sr=ldap_search($ds, 'dc=example,dc=com', "uid=$username");

			/* When the entry exists, there isn't any insertion into LDAP DB */
	    if (ldap_count_entries($ds, $sr) > 0) {
		    $info = ldap_get_entries($ds, $sr);

	    } else {
				/* OK, the entry does not exist in LDAP so insert it into LDAP DB	 */

		    /* prepare data -in LDIF format- for LDAP insertion into DB */
		    $info['uid'] 					= $row['username'];
		    $info['userPassword'] = $row['passwd'];
		    $info['cn'] 					= $row['forename'] . ' ' . $row['surname'];
		    $info['givenName'] 		= $row['forename'];
		    $info['sn'] 					= $row['surname'];
		    $info['mail'] 				= $row['email'];
		    $info['objectclass'] 	= 'inetOrgPerson';

		    /* add data to ldap directory */
		    $distinguishedName = 'uid='.$username . ',ou=people,dc=example,dc=com';
		    $r = ldap_add($ds, $distinguishedName, $info);
	    } 
		}

/**
 * STEP 2: Process all Students from ClaSS DB
 *
 */

	$yearcoms=(array)list_communities('year');

	$Students=array();

	while(list($yearindex,$com)=each($yearcoms)){
		$yid=$com['name'];
		$students=listin_community($com);
		
		while(list($studentindex,$student)=each($students)){
			$sid=$student['id'];
			$Students[$sid]=fetchStudent_short($sid);
			$Email=fetchStudent_singlefield($sid,'EmailAddress');
			$EnrolNumber=fetchStudent_singlefield($sid,'EnrolNumber');
			$EPFUsername=fetchStudent_singlefield($sid,'EPFUsername'); // zzz
			$Students[$sid]['EmailAddress']['value']=$Email['EmailAddress']['value'];
			$Students[$sid]['EPFUsername']['value']=$EPFUsername['EPFUsername']['value']; // zzz

	
	    /* Search for entry in LDAP */
			$username=$Students[$sid]['EPFUsername']['value'];

	    $sr=ldap_search($ds, 'dc=example,dc=com', "uid=$username");

				/* When the entry exists, there isn't any insertion into LDAP DB */
		    if (ldap_count_entries($ds, $sr) > 0) {
			    //$info = ldap_get_entries($ds, $sr);
					//						       
			    //for ($i=0; $i<$info['count']; $i++) {
		  		//	trigger_error(
					//			'dn is: ' . $info[$i]['dn'] . '<br />'
					//			.'first cn entry is: ' . $info[$i]['cn'][0] . '<br />'
					//			.'first email entry is: ' . $info[$i]['mail'][0] . '<br />'
					//			, E_USER_WARNING);
			    //} // end for
	
		    } else {
					/* OK, the entry does not exist in LDAP so insert it into LDAP DB */
					$info=array();
			    /* prepare data -in LDIF format- for LDAP insertion into DB */
			    $info['uid'] 					= $username;
			    //$info['userPassword'] = md5('abc123');
			    $info['userPassword'] = 'abc123';
			    $info['cn'] 					= $Students[$sid]['Forename']['value'] . ' ' . $Students[$sid]['Surname']['value'];
			    $info['givenName']		= $Students[$sid]['Forename']['value'];
			    $info['sn'] 					= $Students[$sid]['Surname']['value'];
			    $info['mail'] 				= $Students[$sid]['EmailAddress']['value'];
			    $info['objectclass'] 	= 'inetOrgPerson';

			    /* add data to ldap directory */
			    $distinguishedName = "uid=$username" . ',ou=people,dc=example,dc=com';
			    
			    $r = ldap_add($ds, $distinguishedName, $info);
			
		    } 
			} 
		}
  ldap_close($ds);
	}
	
} else {
  trigger_error('Unable to connect to LDAP server', E_USER_WARNING);
} 
?>
